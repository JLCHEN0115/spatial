## Fitting with Simple Statistical Model

## Regression Models for Forecasting
>In this small demonstration, We will fit a simple linear model to every pixel in the *Sea Surface Temperature* (SST) data set, and we will use this model to predict SST for a month in which SST data is not available.

**This example is taken from the open source book [Spatio-Temporal Statistics with R](https://spacetimewithr.org/) by  Christopher, Andrew and Noel.**

The model simply contain an intercept and a single regressor, namely, *the Southern Oscillation Index * (SOI)[^1]. We start with some set-ups.

```r
install.packages("STRbook") # You might need to install some system dependency in terminal before, see the suggestion in error message generated by R.
library(devtools)
install_github("andrewzm/STRbook")
```

```r
## Download (if needed) and load package management tools
if (!require("pacman")) install.packages("pacman") 
```

```r
## Download (if needed) and load some packages for spatial analysis
pacman::p_load(broom, tidyverse, STRbook, purrr) 
```

`broom` and `purrr` are used for fitting and predicting with multiple models simultaneously.

For convenience, we will use the already tidied-up data that comes with the package `STRbook`.

```r
data("SST_df", package = "STRbook") 
data("SSTlonlat", package = "STRbook") # load Coordinates data
data("SSTlandmask", package = "STRbook") # load Landmask data (1 = land, 0 = ocean) 
```

We proceed to combine the Landmask data with the coordinates data frame.

```r
lonlatmask_df <- data.frame(cbind(SSTlonlat, SSTlandmask)) 
names(lonlatmask_df) <- c("lon", "lat", "mask")
```

And now, create a data frame containing the SST data from Jan 1970 to Apr 1997.

```r
SST_pre_May <- filter(SST_df, Year <= 1997) %>%
  filter(!(Year == 1997 &
             Month %in% c("May", "Jun", "Jul",
                          "Aug", "Sep", "Oct",
                          "Nov", "Dec"))) 
```

Everything should be in good shape by now. We want to fit linear time-series models to the SSTs in each pixel using data up to April 1997. To do so, we use `purr` and `broom` to construct a nested data frame that contains a linear model fitted to every fixel.

```r
## Create a function that ﬁts the linear model at a single pixel to the data over time.
fit_one_pixel <- function(data)
    mod <- lm(sst ~ 1 + soi, data = data) 
```

Now we can do the estimations.

```r
## Iterate our function to each pixel
pixel_lms <- SST_pre_May %>%
  filter(!is.na(sst)) %>% # remove missing data
  group_by(lon, lat) %>% # group by pixel
  nest() %>% 
  mutate(model = map(data, fit_one_pixel)) %>% 
  mutate(model_df = map(model, tidy)) # extract a data frame containing information on the linear ﬁts of pixels
```

We need to extract the model parameters from the linear-ﬁt data frames.

```r
lm_pars <- pixel_lms %>% 
  unnest(model_df) 
```

```r
## Display the first 10 rows of our estimations.
head(lm_pars, 10) 
```

```
## A tibble: 10 × 9
## Groups:   lon, lat [5]
##     lon   lat data               model  term        estimate std.error statistic    p.value
##   <dbl> <dbl> <list>             <list> <chr>          <dbl>     <dbl>     <dbl>      <dbl>
## 1   154   -29 <tibble [328 × 6]> <lm>   (Intercept)  0.132      0.0266    4.96   0.00000113
## 2   154   -29 <tibble [328 × 6]> <lm>   soi          0.0277     0.0223    1.24   0.216     
## 3   156   -29 <tibble [328 × 6]> <lm>   (Intercept)  0.0365     0.0262    1.40   0.164     
## 4   156   -29 <tibble [328 × 6]> <lm>   soi          0.0835     0.0219    3.81   0.000166  
## 5   158   -29 <tibble [328 × 6]> <lm>   (Intercept)  0.00250    0.0283    0.0884 0.930     
## 6   158   -29 <tibble [328 × 6]> <lm>   soi          0.0981     0.0237    4.15   0.0000431 
## 7   160   -29 <tibble [328 × 6]> <lm>   (Intercept)  0.0179     0.0273    0.656  0.512     
## 8   160   -29 <tibble [328 × 6]> <lm>   soi          0.0927     0.0228    4.06   0.0000622 
## 9   162   -29 <tibble [328 × 6]> <lm>   (Intercept)  0.0318     0.0272    1.17   0.242     
## 10  162   -29 <tibble [328 × 6]> <lm>   soi          0.0997     0.0227    4.38   0.0000157 
```


Now, with a little extra effort, we use the lagged SOI in September 1997 to forecast SST in October 1997.

```r
data("SOI", package = "STRbook") # Get SOI data
SOI_df <- select(SOI, -Ann) %>% 
  gather(Month, soi, -Year)
```
```r
## Get SOI in September 1997 for forecasting
soi_fore <- filter(SOI_df, Month == "Sep" & Year == "1997") %>%
  select(soi)

## Define a new function for forecasting
forecast_one_pixel <- function(lm, soi_pred) {
  predict(lm,                           # use linear model
          newdata = soi_fore,           # predict covariates
          interval = "prediction") %>%  # output intervals
    data.frame() %>%                      # convert to dataframe
    mutate(se = (upr-lwr)/(2 * 1.96)) %>% # compute standard error
    select(fit, se)                       # return fit & se
}
```

```r
## Forecasting the SST for each pixel
SST_Oct_1997 <- pixel_lms %>%
  mutate(fores = map(model,           # Save the ﬁt and prediction standard error as new cols
                     forecast_one_pixel,
                     soi_pred = soi_pred)) %>%
  unnest(fores)                           # Unnest the foress data
```

Instead of throwing a block of text output, I will just visualize it here.

```r
forecase_plot <- ggplot(SST_Oct_1997, aes(lon, lat, z = fit)) +
     geom_contour(aes(colour = after_stat(level))) +
     fill_scale() +
     theme_bw() + 
     coord_fixed() +
     labs(
       title = "Forecasted Sea Sea Surface Temperature (SST)"
     )
forecase_plot
```

And here it is. (**Say Hi to that cute smiling guy** :smiley:)

![](/Figures/forecast_plot.png)<!-- -->

[^1]: The *Southern Oscillation Index* (SOI) is one measure of the large-scale fluctuations in air pressure occurring between the western and eastern tropical Pacific (i.e., the state of the Southern Oscillation) during *El Niño* and *La Niña* (They are extreme weather phenomenons) episodes.